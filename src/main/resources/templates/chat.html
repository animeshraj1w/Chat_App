<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Chat Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">Real-Time Chat Application</h1>
        <div id="chat"
             class="border rounded p-3 mb-3"
             style="height:300px; overflow-y:auto;">
        </div>
        <div class="input-group mb-3">
            <input id="senderInput" type = "text" class="form-control"
                   placeholder="Your name...."/>
            </div>

        <form id="messageForm" onsubmit="return sendMessage()">
            <div class="input-group mb-3">
                <input id="messageInput" type="text" class="form-control"
                       placeholder="Type a message...."/>
                <div id="input-group-append">
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </div>
        </form>
    </div>
</body>
<script>
    // Use the global Stomp object from the CDN
    const socket = new SockJS('/chat');
    const stompClient = Stomp.over(socket);
    
    // Enable debug logging (helpful for troubleshooting)
    stompClient.debug = function(str) {
        console.log('STOMP: ' + str);
    };
    
    function connect() {
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            
            // Subscribe to the topic that matches your backend configuration
            stompClient.subscribe('/topic/messages', function(message) {
                console.log('Received message: ' + message.body);
                showMessage(JSON.parse(message.body));
            });
            
        }, function(error) {
            console.error('STOMP protocol error: ' + error);
            console.log('Retrying connection...');
            setTimeout(connect, 5000); // Try to reconnect after 5 seconds
        });
    }
    
    function showMessage(message) {
        const chat = document.getElementById('chat');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${message.sender}: ${message.content}`;
        messageElement.className = "border-bottom mb-1 p-2";
        chat.appendChild(messageElement);
        chat.scrollTop = chat.scrollHeight;
    }
    
    function sendMessage() {
        try {
            const sender = document.getElementById('senderInput').value.trim();
            const content = document.getElementById('messageInput').value.trim();
            
            if (!sender || !content) {
                alert('Please enter both your name and a message');
                return false; // Prevent form submission
            }
            
            if (stompClient && stompClient.connected) {
                const chatMessage = {
                    sender: sender,
                    content: content
                    // Removed type field to match backend model
                };
                
                console.log('Sending message:', chatMessage);
                stompClient.send("/app/sendMessage", {}, JSON.stringify(chatMessage));
                document.getElementById('messageInput').value = '';
                return false; // Prevent form submission
            } else {
                console.error('WebSocket connection not established');
                alert('Not connected. Trying to reconnect...');
                connect();
                return false; // Prevent form submission
            }
        } catch (error) {
            console.error('Error sending message:', error);
            return false; // Prevent form submission
        }
    }
    
    // Initialize connection when the page loads
    connect();
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Form submission is now handled by the form's onsubmit event
        
        // Allow sending message with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                sendMessage();
            }
        });
    });
</script>
</html>